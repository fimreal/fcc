variant: fcos
version: 1.4.0
kernel_arguments:
  should_exist:
    - selinux=0
passwd:
  users:
    - name: lmr
      groups:
        - docker
        - sudo
      password_hash: $y$j9T$avmZo2f7txYwPs3H02yTk/$3sXp/LMxj7.lTTGadKyu5qb8PJzdXhM44zYQIr3AyV4
      home_dir: /home/lmr
      shell: /bin/bash
    - name: root
      ssh_authorized_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDBTed9KFiRw30p42s/PXgUHzguu5IwhYcapiwQm0RfV"
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGj+52psmR65lVP9FkxWvTZSUlDZllhAhzeP9na7HadX"
systemd:
  units:
    # custom os extensions
    - name: rpm-ostree-install-extensions.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer extensions with rpm-ostree
        Wants=network-online.target
        After=network-online.target
        # We run before `zincati.service` to avoid conflicting rpm-ostree
        # transactions.
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        # `--allow-inactive` ensures that rpm-ostree does not return an error
        # if the package is already installed. This is useful if the package is
        # added to the root image in a future Fedora CoreOS release as it will
        # prevent the service from failing.
        ExecStart=/usr/bin/rpm-ostree install --apply-live --allow-inactive vim vim wget iftop iotop lsyncd mtr nethogs nmap policycoreutils-python-utils python3 pip tcpdump ansible
        ExecStart=/bin/touch /var/lib/%N.stamp

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          fcos
    - path: /etc/profile.d/zz-default-editor.sh
      overwrite: true
      contents:
        inline: |
          export EDITOR=vim
    - path: /etc/sysctl.d/20-silence-audit.conf
      mode: 0644
      contents:
        inline: |
          # Raise console message logging level from DEBUG (7) to WARNING (4)
          # to hide audit messages from the interactive console
          kernel.printk=4
    - path: /etc/sysctl.d/90-ipv4-ip-forward.conf
      mode: 0644
      contents:
        inline: |
          net.ipv4.ip_forward = 1

    - path: /etc/sysctl.d/90-ipv6-ip-forwarding.conf
      mode: 0644
      contents:
        inline: |
          net.ipv6.conf.all.forwarding = 1
  # - path: /etc/profile.d/systemd-pager.sh
  #   mode: 0644
  #   contents:
  #     inline: |
  #       # Tell systemd to not use a pager when printing information
  #       export SYSTEMD_PAGER=cat
    - path: /etc/ssh/sshd_config.d/99-sshd.conf
      mode: 0644
      contents:
        inline: |
          Port 1231
          ClientAliveInterval 180
          PasswordAuthentication yes
    - path: /etc/NetworkManager/conf.d/no-dns.conf
      mode: 0644
      contents:
        inline: |
          [main]
          dns=none
    - path: /etc/systemd/zram-generator.conf
      mode: 0644
      contents:
        inline: |
          # This config file enables a /dev/zram0 device with the default settings
          [zram0]
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/Asia/Shanghai
